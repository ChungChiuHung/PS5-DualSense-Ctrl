<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DualSense Haptic Ctrl</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@900&display=swap');
        
        body { margin: 0; background: #050507; color: #e2e8f0; font-family: 'JetBrains+Mono', monospace; overflow: hidden; user-select: none; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .glass { background: rgba(10, 10, 15, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        /* Custom Sliders */
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 2px; background: rgba(255, 255, 255, 0.1); }
        input[type=range]::-webkit-slider-thumb { height: 12px; width: 12px; border-radius: 2px; background: #3b82f6; -webkit-appearance: none; margin-top: -5px; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }

        .btn-active { background: #3b82f6 !important; color: white !important; box-shadow: 0 0 15px rgba(59, 130, 246, 0.8); border-color: #60a5fa; transform: scale(1.02); }
        
        /* Analog Stick Visualizer */
        .stick-track { width: 60px; height: 60px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; position: relative; }
        .stick-dot { width: 12px; height: 12px; background: #3b82f6; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: transform 0.05s linear; }
        
        .label-xs { font-size: 9px; text-transform: uppercase; letter-spacing: 0.15em; font-weight: 700; color: #64748b; }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <!-- Main Dashboard -->
    <div class="fixed top-6 left-6 flex flex-col gap-4 z-50">
        <div class="p-6 glass rounded-2xl w-80 shadow-2xl">
            <h1 class="orbitron text-xl font-black text-blue-500 tracking-tighter mb-1">HAPTIC.CTRL</h1>
            <div class="flex items-center gap-2 mb-6">
                <div id="status-dot" class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></div>
                <p id="status-text" class="label-xs text-gray-500">Searching for Bridge...</p>
            </div>

            <div class="space-y-6">
                <!-- Gain Control -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="label-xs">Intensity (Gain)</label>
                        <span id="gain-val" class="text-xs text-blue-400 font-bold">1.5x</span>
                    </div>
                    <input type="range" id="gain-slider" min="0" max="5" step="0.1" value="1.5" class="w-full">
                </div>

                <!-- Low Pass -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="label-xs">Haptic Cutoff</label>
                        <span id="freq-val" class="text-xs text-blue-400 font-bold">60Hz</span>
                    </div>
                    <input type="range" id="freq-slider" min="25" max="60" step="1" value="60" class="w-full">
                </div>

                <!-- Generator -->
                <div class="pt-4 border-t border-white/5">
                    <div class="flex justify-between items-center mb-2">
                        <label class="label-xs text-blue-500">Manual Sine Gen</label>
                        <span id="test-freq-val" class="text-xs text-blue-300">25Hz</span>
                    </div>
                    <input type="range" id="test-freq-slider" min="25" max="60" step="1" value="25" class="w-full mb-3">
                    <button id="test-tone-btn" class="w-full py-2 border border-blue-500/20 text-[10px] font-bold tracking-widest hover:bg-blue-500/10 rounded-lg transition-all">
                        ACTIVATE TEST TONE
                    </button>
                </div>

                <button id="toggle-btn" class="w-full py-4 bg-blue-600 hover:bg-blue-500 transition-all rounded-xl font-black text-[10px] tracking-widest">
                    INITIALIZE ENGINE
                </button>
            </div>
        </div>

        <!-- Sticks Visualizer -->
        <div class="p-4 glass rounded-2xl flex justify-around items-center">
            <div class="flex flex-col items-center gap-2">
                <div class="stick-track"><div id="ls-dot" class="stick-dot"></div></div>
                <span class="label-xs">LS</span>
            </div>
            <div class="flex flex-col items-center gap-2">
                <div class="stick-track"><div id="rs-dot" class="stick-dot"></div></div>
                <span class="label-xs">RS</span>
            </div>
        </div>
    </div>

    <!-- Input Monitor Grid -->
    <div class="fixed top-6 right-6 p-6 glass rounded-2xl w-64 shadow-2xl z-50">
        <h2 class="label-xs mb-4">Device Input Stream</h2>
        <div id="input-grid" class="grid grid-cols-2 gap-2">
            <!-- Dynamically injected -->
        </div>
        <div class="mt-4 pt-4 border-t border-white/5 space-y-1">
            <div class="flex justify-between label-xs"><span class="text-gray-600 italic">Up/Down:</span> <span>Hz +/-</span></div>
            <div class="flex justify-between label-xs"><span class="text-gray-600 italic">Left/Right:</span> <span>Gain +/-</span></div>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:5182";
        let engineActive = false;
        let testToneActive = false;
        let sticks = { lsX: 0, lsY: 0, rsX: 0, rsY: 0 };

        // Unified button list including Dpad
        const BUTTONS = [
            'DpadUp', 'DpadDown', 'DpadLeft', 'DpadRight',
            'Cross', 'Circle', 'Square', 'Triangle',
            'L1', 'R1', 'L2', 'R2',
            'Share', 'Options', 'L3', 'R3', 'PS', 'Touchpad'
        ];

        const inputGrid = document.getElementById('input-grid');
        BUTTONS.forEach(btn => {
            const el = document.createElement('div');
            el.id = `btn-${btn.toLowerCase()}`;
            el.className = "text-[8px] py-1.5 border border-white/5 rounded text-gray-700 bg-white/5 uppercase font-bold text-center transition-all duration-75";
            el.innerText = btn.replace('Dpad', 'D-');
            inputGrid.appendChild(el);
        });

        // --- Three.js Logic ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Core Visualization
        const coreGeo = new THREE.IcosahedronGeometry(2.5, 1);
        const coreMat = new THREE.MeshPhongMaterial({ color: 0x3b82f6, wireframe: true, transparent: true, opacity: 0.2 });
        const core = new THREE.Mesh(coreGeo, coreMat);
        scene.add(core);

        // Movement Point
        const point = new THREE.Mesh(
            new THREE.SphereGeometry(0.15, 16, 16),
            new THREE.MeshBasicMaterial({ color: 0x60a5fa })
        );
        const pointLight = new THREE.PointLight(0x3b82f6, 4, 15);
        point.add(pointLight);
        scene.add(point);

        scene.add(new THREE.AmbientLight(0x404040, 2));
        camera.position.z = 8;

        // UI Selectors
        const toggleBtn = document.getElementById('toggle-btn');
        const gainSlider = document.getElementById('gain-slider');
        const freqSlider = document.getElementById('freq-slider');
        const testFreqSlider = document.getElementById('test-freq-slider');
        const testToneBtn = document.getElementById('test-tone-btn');
        const statusDot = document.getElementById('status-dot');

        // Actions
        toggleBtn.onclick = async () => {
            const endpoint = engineActive ? '/stop' : '/start';
            const res = await fetch(API_BASE + endpoint, { method: 'POST' }).catch(() => null);
            if (res && res.ok) {
                engineActive = !engineActive;
                toggleBtn.innerText = engineActive ? "STOP ENGINE" : "INITIALIZE ENGINE";
                toggleBtn.style.background = engineActive ? "#ef4444" : "#2563eb";
            }
        };

        testToneBtn.onclick = async () => {
            testToneActive = !testToneActive;
            testToneBtn.innerText = testToneActive ? "STOP TEST TONE" : "ACTIVATE TEST TONE";
            testToneBtn.classList.toggle('border-blue-500');
            await fetch(`${API_BASE}/test-mode/${testToneActive ? 'on' : 'off'}`, { method: 'POST' }).catch(() => null);
        };

        // Inputs
        gainSlider.oninput = () => updateParam('/gain', gainSlider.value, 'gain-val', 'x');
        freqSlider.oninput = () => updateParam('/frequency', freqSlider.value, 'freq-val', 'Hz');
        testFreqSlider.oninput = () => updateParam('/generate', testFreqSlider.value, 'test-freq-val', 'Hz');

        async function updateParam(path, val, displayId, suffix) {
            document.getElementById(displayId).innerText = val + suffix;
            await fetch(`${API_BASE}${path}/${val}`, { method: 'POST' }).catch(() => null);
        }

        async function updateStatus() {
            try {
                const res = await fetch(API_BASE + '/status');
                const data = await res.json();
                
                if (data.connected) {
                    statusDot.className = "w-1.5 h-1.5 rounded-full bg-green-500";
                    document.getElementById('status-text').innerText = data.device;
                    sticks = data.sticks;

                    // Sync sliders if not active
                    if (!gainSlider.matches(':active')) {
                        gainSlider.value = data.gain;
                        document.getElementById('gain-val').innerText = parseFloat(data.gain).toFixed(1) + 'x';
                    }
                    if (!freqSlider.matches(':active')) {
                        freqSlider.value = data.filter;
                        document.getElementById('freq-val').innerText = Math.round(data.filter) + 'Hz';
                    }
                    if (!testFreqSlider.matches(':active')) {
                        testFreqSlider.value = data.generatorFreq;
                        document.getElementById('test-freq-val').innerText = Math.round(data.generatorFreq) + 'Hz';
                    }

                    // Analog Visuals
                    document.getElementById('ls-dot').style.transform = `translate(${-50 + sticks.lsX * 150}%, ${-50 + sticks.lsY * 150}%)`;
                    document.getElementById('rs-dot').style.transform = `translate(${-50 + sticks.rsX * 150}%, ${-50 + sticks.rsY * 150}%)`;

                    // Buttons
                    BUTTONS.forEach(btn => {
                        const el = document.getElementById(`btn-${btn.toLowerCase()}`);
                        if (data.buttons.includes(btn)) el.classList.add('btn-active');
                        else el.classList.remove('btn-active');
                    });
                } else {
                    statusDot.className = "w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse";
                    document.getElementById('status-text').innerText = "Searching...";
                }
            } catch (e) { 
                statusDot.className = "w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse";
                document.getElementById('status-text').innerText = "Bridge Offline";
            }
        }

        setInterval(updateStatus, 80);

        // Render loop
        let orbitX = 0, orbitY = 0;
        function animate() {
            requestAnimationFrame(animate);
            
            // Move Point LS
            point.position.x += sticks.lsX * 0.12;
            point.position.y -= sticks.lsY * 0.12;
            point.position.x = Math.max(-5, Math.min(5, point.position.x));
            point.position.y = Math.max(-4, Math.min(4, point.position.y));

            // View RS
            orbitX += sticks.rsX * 0.04;
            orbitY = Math.max(-1.5, Math.min(1.5, orbitY + sticks.rsY * 0.04));
            
            const r = 8;
            camera.position.x = r * Math.sin(orbitX) * Math.cos(orbitY);
            camera.position.z = r * Math.cos(orbitX) * Math.cos(orbitY);
            camera.position.y = r * Math.sin(orbitY);
            camera.lookAt(0, 0, 0);

            core.rotation.y += 0.005;
            if (engineActive || testToneActive) {
                const s = 1 + Math.sin(Date.now()*0.01) * 0.1;
                core.scale.set(s,s,s);
                core.material.opacity = 0.4;
            } else {
                core.scale.set(1,1,1);
                core.material.opacity = 0.1;
            }

            renderer.render(scene, camera);
        }
        animate();

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>